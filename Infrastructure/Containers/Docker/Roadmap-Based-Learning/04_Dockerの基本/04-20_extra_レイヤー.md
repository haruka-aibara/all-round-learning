# Docker講義：レイヤー

## 概要
Dockerのレイヤーは、イメージの構築と最適化の基盤となる重要な概念です。

## レイヤーとは
レイヤーとはDockerイメージを構成する読み取り専用のファイルシステムで、Dockerfileの各命令によって作成されます。

## レイヤーの仕組み

### レイヤーの構造
- Dockerイメージは複数のレイヤーが積み重なった構造になっています
- 各レイヤーは前のレイヤーに対する「差分」として保存されます
- レイヤーはイミュータブル（不変）であり、一度作成されると変更できません

### レイヤーの作成
以下のDockerfile命令により新しいレイヤーが作成されます：
- `FROM` - ベースイメージのレイヤー
- `RUN` - コマンド実行による変更
- `COPY` - ファイルのコピー
- `ADD` - ファイルの追加（圧縮ファイルの展開機能付き）

### レイヤーの利点
- **ストレージ効率**：共通レイヤーは複数のイメージ間で共有されます
- **ビルド高速化**：変更がないレイヤーはキャッシュから再利用されます
- **配布効率**：変更されたレイヤーのみを転送できます

### コンテナレイヤー
- コンテナ実行時には、イメージレイヤー（読み取り専用）の上に書き込み可能な「コンテナレイヤー」が追加されます
- ファイル変更時には「Copy-on-Write」メカニズムが適用されます

### レイヤーの確認方法
```bash
# イメージのレイヤー構造を確認
docker history イメージ名

# レイヤーの詳細情報を表示
docker inspect イメージ名
```

## レイヤーを意識したDockerfile最適化

### レイヤー数削減のベストプラクティス
- 関連するコマンドは`&&`で連結して1つの`RUN`命令にまとめる
- 不要なファイルは同じレイヤー内で削除する
- マルチステージビルドを活用して最終イメージのレイヤーを減らす

### 悪い例と良い例

**悪い例（レイヤーが多い）**：
```dockerfile
FROM ubuntu:20.04
RUN apt-get update
RUN apt-get install -y nginx
RUN apt-get install -y curl
RUN rm -rf /var/lib/apt/lists/*
```

**良い例（レイヤーを最適化）**：
```dockerfile
FROM ubuntu:20.04
RUN apt-get update && \
    apt-get install -y nginx curl && \
    rm -rf /var/lib/apt/lists/*
```

## キャッシュ戦略
- 変更頻度の低いレイヤーを先に配置する
- ソースコードなど頻繁に変更されるファイルは後のレイヤーでコピーする
- `.dockerignore`ファイルを使用して不要なファイルをコンテキストから除外する
