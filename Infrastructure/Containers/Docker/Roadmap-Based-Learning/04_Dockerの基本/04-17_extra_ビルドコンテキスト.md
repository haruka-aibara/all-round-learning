# Dockerビルドコンテキスト

## 概要
ビルドコンテキストとは、Dockerイメージをビルドする際に使用されるファイルセットの集合であり、効率的なイメージ構築のための基盤となります。

## 理論的説明
ビルドコンテキストは`docker build`コマンド実行時にDockerデーモンに送信される現在のディレクトリ（またはURL）内のファイル群で、Dockerfileからの相対パスの起点となります。

## ビルドコンテキストの基本

### ビルドコンテキストとは何か
- ビルドコンテキストは、`docker build`コマンドに指定したパス内の**すべてのファイルとディレクトリ**です
- デフォルトでは、カレントディレクトリ（`.`）がビルドコンテキストになります
- 例: `docker build .` の場合、現在のディレクトリがビルドコンテキストになります

### ビルドコンテキストの送信プロセス
1. `docker build`コマンドを実行すると、指定したパス内のすべてのファイルがDockerデーモンに送信されます
2. 大きなコンテキストは送信に時間がかかり、ビルド速度が低下します
3. デーモンはコンテキスト内のファイルのみアクセス可能で、外部ファイルは参照できません

## .dockerignoreファイル

### .dockerignoreの役割
- ビルドコンテキストから特定のファイルやディレクトリを除外するための設定ファイル
- Gitの`.gitignore`と同様の機能と書式を持ちます
- ビルドコンテキストのルートディレクトリ（Dockerfileと同じ場所）に配置します

### .dockerignoreの書き方と効果
```
# コメント行
*/temp*      # 直下のディレクトリ内のtempで始まるファイル/ディレクトリを除外
*/*/temp*    # 二階層目のディレクトリ内のtempで始まるファイル/ディレクトリを除外
node_modules # node_modulesディレクトリを除外
.git         # .gitディレクトリを除外
*.md         # すべてのMarkdownファイルを除外
!README.md   # ただしREADME.mdは含める（除外から除外）
```

### .dockerignoreの利点
- ビルド速度の向上：不要なファイルを送信しないため処理が速くなります
- イメージサイズの削減：誤って不要なファイルが含まれるのを防ぎます
- セキュリティの向上：機密ファイル（`.env`など）がイメージに入るのを防ぎます

## ビルドコンテキストの最適化

### パフォーマンス上の問題点
- 大きなビルドコンテキストは次の問題を引き起こします：
  - ビルド開始までの時間が長くなる
  - メモリ使用量が増加する
  - イメージが不必要に大きくなる可能性がある

### 最適化のベストプラクティス
1. 必要最小限のファイルだけを含むディレクトリでビルドする
2. 適切な`.dockerignore`ファイルを作成する
3. マルチステージビルドを活用して最終イメージを軽量化する
4. 専用のビルドディレクトリを作成してコンテキストを分離する

## 実践例

### 基本的なビルドコンテキストの使用
```bash
# カレントディレクトリをビルドコンテキストとして使用
docker build -t myapp:latest .

# 特定のディレクトリをビルドコンテキストとして指定
docker build -t myapp:latest ./src

# 別の場所にあるDockerfileを使用しつつ、カレントディレクトリをコンテキストとする
docker build -t myapp:latest -f ./docker/Dockerfile .
```

### ビルドコンテキストとDockerfile内のパス
Dockerfileの中で使用するパスはすべてビルドコンテキストからの相対パスになります：

```dockerfile
# src/app.js をコンテナ内の /app/app.js にコピーする場合
COPY src/app.js /app/

# ビルドコンテキスト全体をコンテナ内の /app にコピーする場合
COPY . /app/
```

### 注意点
- `COPY`や`ADD`命令で指定するパスは、常にビルドコンテキストのルートからの相対パスです
- ビルドコンテキスト外のファイルは`COPY`や`ADD`でアクセスできません
- `RUN`命令内でのパスはコンテナ内のファイルシステムを基準にします

## まとめ
ビルドコンテキストを適切に設定することで、Dockerイメージのビルドプロセスを効率化し、より軽量で安全なイメージを作成できます。特に`.dockerignore`ファイルの活用と必要最小限のファイルのみを含めることが重要です。
