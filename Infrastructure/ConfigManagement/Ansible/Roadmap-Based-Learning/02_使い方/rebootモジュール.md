# Ansible rebootモジュール講座

## 1. トピックの概要と重要性

rebootモジュールは、Ansibleを使用して対象ホストを安全に再起動するための専用モジュールです。サーバー管理における計画的なメンテナンスや更新後の再起動において重要な役割を果たします。

## 2. 主要概念の理論的説明

rebootモジュールは、システムの再起動プロセスを制御し、再起動前後の待機時間や再接続の試行回数などを細かく設定できるため、運用環境での安全な再起動操作を実現します。

## 3. 基本的な使用方法

### 3.1 シンプルな再起動例

```yaml
- name: サーバーを再起動する
  reboot:
```

このシンプルな例では、デフォルト設定でホストを再起動します。

### 3.2 主要パラメータ

rebootモジュールでは以下の主要パラメータを調整できます：

| パラメータ | 説明 | デフォルト値 |
|------------|------|-------------|
| `msg` | 再起動時にシステムログに記録されるメッセージ | "Ansible による再起動" |
| `pre_reboot_delay` | 再起動コマンド実行前の待機時間（秒） | 0 |
| `post_reboot_delay` | 再起動後、接続チェック開始までの待機時間（秒） | 0 |
| `reboot_timeout` | 再起動完了を待機する最大時間（秒） | 600 |
| `connect_timeout` | 再接続試行ごとのタイムアウト時間（秒） | 5 |
| `test_command` | ホスト再起動後の接続テストに使用するコマンド | "whoami" |

## 4. 実践的な使用例

### 4.1 カスタムメッセージと待機時間

```yaml
- name: セキュリティアップデート後の再起動
  reboot:
    msg: "セキュリティパッチ適用後の計画再起動"
    pre_reboot_delay: 30
    post_reboot_delay: 60
    reboot_timeout: 1800
```

この例では：
- 再起動の理由をログに記録
- 再起動前に30秒待機（アプリケーションの終了処理などのため）
- 再起動後、接続チェック開始まで60秒待機
- 最大30分（1800秒）まで再起動完了を待機

### 4.2 複数サーバーの順次再起動（プレイブック例）

```yaml
---
- name: データベースサーバー群の計画再起動
  hosts: db_servers
  serial: 1  # 1台ずつ順番に処理
  tasks:
    - name: メンテナンスモードに切り替え
      command: /opt/maintenance_scripts/enable_maintenance.sh
      
    - name: サーバー再起動
      reboot:
        msg: "週次メンテナンス再起動"
        pre_reboot_delay: 120  # アプリケーション接続終了のための待機
        reboot_timeout: 900    # 15分のタイムアウト
      
    - name: メンテナンスモードを解除
      command: /opt/maintenance_scripts/disable_maintenance.sh
```

この例では、`serial: 1` ディレクティブを使用して、データベースサーバーを1台ずつ順番に再起動します。

## 5. 注意点と応用テクニック

### 5.1 条件付き再起動

```yaml
- name: カーネルアップデート後のみ再起動
  reboot:
    msg: "カーネルアップデート後の再起動"
    reboot_timeout: 1200
  when: kernel_updated.changed
```

特定の条件（この例ではカーネルの更新）が満たされた場合にのみ再起動します。

### 5.2 エラーハンドリング

```yaml
- name: 再起動を試行
  reboot:
    msg: "システムアップデート後の再起動"
    reboot_timeout: 900
  register: reboot_result
  ignore_errors: yes
  
- name: 再起動失敗時の通知
  debug:
    msg: "サーバーの再起動に失敗しました！手動確認が必要です。"
  when: reboot_result.failed
```

再起動操作の結果を変数に格納し、失敗時に管理者向けメッセージを表示します。

## 6. まとめ

rebootモジュールは、サーバー再起動という一見シンプルな操作を自動化・安全化するための強力なツールです。適切なパラメータ設定により、運用環境での計画的な再起動を効率的に実施できます。初心者の方も、基本的な使用例から始めて徐々に応用例に取り組むことで、システム運用の安全性と効率性を向上させることができるでしょう。
