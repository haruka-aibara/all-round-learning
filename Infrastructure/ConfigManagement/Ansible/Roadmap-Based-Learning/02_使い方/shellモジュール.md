# Ansible shellモジュール

## 1. 概要と重要性

shellモジュールはAnsibleで直接シェルコマンドを実行するための基本的かつ強力なモジュールです。他のモジュールでは実現できない複雑な操作や既存のシェルスクリプトを活用する場合に重要です。

## 2. 理論的説明

shellモジュールはターゲットホスト上でシェルコマンド（/bin/sh）を実行し、環境変数、パイプ、リダイレクトなどのシェル機能を利用できます。

## 3. 基本的な使い方

```yaml
- name: サーバー上で日付コマンドを実行
  shell: date
  register: 実行結果
  
- name: 結果を表示
  debug:
    var: 実行結果.stdout
```

## 4. 主要パラメータ

| パラメータ名 | 説明 | 例 |
|------------|------|-----|
| cmd | 実行するコマンド（省略可） | `ls -la /var/log` |
| chdir | コマンド実行前に移動するディレクトリ | `/opt/システム/ログ` |
| creates | 指定したファイルが存在する場合、コマンドをスキップ | `/tmp/処理済みフラグ.txt` |
| removes | 指定したファイルが存在しない場合、コマンドをスキップ | `/var/run/サービス.pid` |
| executable | 使用するシェルを指定 | `/bin/bash` |
| warn | 警告メッセージを表示するかどうか | `false` |

## 5. 実践例

### 例1: ディレクトリ変更して実行

```yaml
- name: アプリケーションビルド
  shell: make install
  args:
    chdir: /home/管理者/アプリソース
```

### 例2: ファイル存在チェックでスキップ

```yaml
- name: 大容量ログファイル圧縮
  shell: tar -czf 古いログ.tar.gz *.log && rm *.log
  args:
    chdir: /var/log/システムA
    creates: 古いログ.tar.gz
```

### 例3: シェルスクリプト実行と結果取得

```yaml
- name: カスタムスクリプト実行
  shell: /opt/運用ツール/ヘルスチェック.sh
  register: 診断結果
  
- name: 診断結果の確認
  debug:
    msg: "システム状態: {{ 診断結果.stdout }}"
  when: 診断結果.rc == 0
```

### 例4: パイプとリダイレクト

```yaml
- name: プロセス検索とカウント
  shell: ps aux | grep アプリケーションX | grep -v grep | wc -l
  register: プロセス数
  
- name: 結果の確認
  fail:
    msg: "アプリケーションXのプロセスが動作していません"
  when: プロセス数.stdout == "0"
```

## 6. 注意点

- **セキュリティリスク**: 変数を使用する際は必ず `{{ var | quote }}` でエスケープし、インジェクション攻撃を防止
- **冪等性の欠如**: デフォルトでは毎回実行されるため、`creates`/`removes` パラメータを活用して冪等性を確保
- **代替モジュールの検討**: 可能な限り専用モジュール（`file`, `copy`, `template` など）を使用する
- **エラーハンドリング**: `register` と `failed_when` を組み合わせて適切なエラー処理を実装する

## 7. command モジュールとの違い

| 機能 | shell モジュール | command モジュール |
|-----|----------------|------------------|
| 環境変数 | ✓ 対応 | × 非対応 |
| パイプ | ✓ 対応 | × 非対応 |
| リダイレクト | ✓ 対応 | × 非対応 |
| シェル展開 | ✓ 対応 | × 非対応 |
| セキュリティ | 注意が必要 | 比較的安全 |

## 8. ベストプラクティス

1. **可能な限り専用モジュールを使用**: 特定の操作には専用モジュールを優先する
2. **冪等性を確保**: `creates`/`removes` を活用し、不要な再実行を防止
3. **変数は必ずエスケープ**: `{{ 変数 | quote }}` でシェルインジェクションを防止
4. **戻り値のチェック**: `register` と `failed_when` で適切にエラー処理
5. **デバッグを容易に**: `-v` オプションでコマンド実行を確認できるようにする

## 9. 実践的なタスク例

バックアップとローテーション:

```yaml
- name: データベースバックアップ
  shell: |
    pg_dump データベース名 > /バックアップ/DB_{{ ansible_date_time.date }}.sql
    find /バックアップ/ -name "DB_*.sql" -mtime +7 -delete
  args:
    executable: /bin/bash
```

---

このマークダウンは、Ansible初心者から中級者を対象としたshellモジュールの基本と実践的な使い方についての講座です。理解しやすい日本語の例とともに、重要な概念を簡潔に説明しています。
