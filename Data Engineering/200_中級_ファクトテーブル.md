# ファクトテーブル (難易度レベル: 200)

## 概要
ファクトテーブルは、データウェアハウス（DWH）やビジネスインテリジェンス（BI）システムにおいて、ビジネスの事実（事象）を記録する中心的なテーブルです。売上、注文数、訪問者数などの数値的な指標（メジャー）と、それらを分析するための次元キー（ディメンションキー）で構成されています。ファクトテーブルを理解することで、効果的なデータ分析基盤を構築できるようになります。

## 詳細

### ファクトテーブルの基本構造
ファクトテーブルは以下の要素で構成されています：

- **ファクト（事実）**: ビジネスの数値的な指標
- **ディメンションキー**: 分析軸となる外部キー
- **粒度（Granularity）**: データの詳細レベル

### 重要なポイント

#### 1. ファクトの種類
- **加法性ファクト**: 合計が意味を持つ数値（売上金額、数量など）
- **半加法性ファクト**: 特定の次元でのみ合計が意味を持つ数値（在庫数など）
- **非加法性ファクト**: 合計が意味を持たない数値（比率、平均など）

#### 2. 粒度の重要性
ファクトテーブルの粒度は、データの詳細レベルを決定します。粒度が細かいほど詳細な分析が可能ですが、データ量も増加します。

#### 3. スタースキーマとの関係
ファクトテーブルは、スタースキーマの中心に位置し、複数のディメンションテーブルと結合することで多次元分析を実現します。

### 関連する概念
- **ディメンションテーブル**: 分析軸となる属性を格納
- **スノーフレークスキーマ**: 正規化されたディメンション構造
- **集約ファクトテーブル**: 事前集計されたファクトテーブル

### 使用シーン
- 売上分析システム
- 在庫管理システム
- 顧客行動分析
- 財務分析システム
- ログ分析システム

### 実践的な活用方法
1. **ビジネス要件の分析**: どのような分析が必要かを明確化
2. **粒度の決定**: 分析に必要な最小単位を設定
3. **ファクトの選択**: 分析対象となる数値指標を特定
4. **ディメンションの設計**: 分析軸となる属性を定義

## 具体例

### 基本的な使用例：ECサイトの売上ファクトテーブル

```sql
-- 売上ファクトテーブルの例
CREATE TABLE sales_fact (
    -- ファクト（数値指標）
    sales_amount DECIMAL(10,2),    -- 売上金額
    quantity INT,                  -- 数量
    unit_price DECIMAL(8,2),       -- 単価
    
    -- ディメンションキー
    date_key INT,                  -- 日付キー
    product_key INT,               -- 商品キー
    customer_key INT,              -- 顧客キー
    store_key INT,                 -- 店舗キー
    
    -- メタデータ
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

### 応用例：複数のファクトテーブル設計

#### 1. 在庫ファクトテーブル
```sql
CREATE TABLE inventory_fact (
    -- ファクト
    stock_quantity INT,            -- 在庫数量
    reorder_level INT,             -- 発注点
    
    -- ディメンションキー
    date_key INT,                  -- 日付キー
    product_key INT,               -- 商品キー
    warehouse_key INT,             -- 倉庫キー
    
    created_at TIMESTAMP
);
```

#### 2. 顧客行動ファクトテーブル
```sql
CREATE TABLE customer_behavior_fact (
    -- ファクト
    page_view_count INT,           -- ページビュー数
    session_duration INT,          -- セッション時間（秒）
    conversion_flag BOOLEAN,       -- コンバージョンフラグ
    
    -- ディメンションキー
    date_key INT,                  -- 日付キー
    customer_key INT,              -- 顧客キー
    page_key INT,                  -- ページキー
    campaign_key INT,              -- キャンペーンキー
    
    created_at TIMESTAMP
);
```

### 注意点やベストプラクティス

#### 1. ファクトテーブル設計の原則
- **粒度の一貫性**: 1つのファクトテーブル内では同じ粒度を維持
- **ファクトの加法性**: 可能な限り加法性ファクトを選択
- **ディメンションキーの適切な設計**: 分析に必要な次元を漏れなく含める

#### 2. パフォーマンス最適化
- **適切なインデックス**: ディメンションキーにインデックスを作成
- **パーティショニング**: 日付キーによるパーティショニング
- **集約ファクトテーブル**: 頻繁に使用される集計結果を事前計算

#### 3. データ品質の確保
- **NULL値の管理**: ファクトにはNULL値を避ける
- **整合性チェック**: ディメンションテーブルとの参照整合性を確保
- **データ型の適切な選択**: 精度とストレージ効率のバランス

## まとめ

ファクトテーブルは、データウェアハウス設計の核となる概念です。ビジネスの事実を適切にモデル化することで、効果的な分析基盤を構築できます。

### 学んだことの振り返り
- ファクトテーブルの基本構造と役割
- ファクトの種類（加法性、半加法性、非加法性）
- 粒度の重要性と設計原則
- 実践的なファクトテーブル設計例

### 次のステップへの提案
1. **ディメンションテーブルの設計**: ファクトテーブルと組み合わせた完全なスタースキーマの理解
2. **ETLプロセスの設計**: ファクトテーブルへのデータ投入方法の学習
3. **集約ファクトテーブルの活用**: パフォーマンス最適化手法の習得
4. **実際のプロジェクトでの実装**: 実務でのファクトテーブル設計経験の積み重ね

ファクトテーブルを正しく理解し、適切に設計することで、ビジネスインテリジェンスシステムの基盤となる堅牢なデータモデルを構築できるようになります。 
