# リソース要求と制限の設定

## 1. リソース要求と制限とは

Kubernetesでは、コンテナの実行に必要なリソース（CPUとメモリ）を2つの観点から指定できます：

- **リソース要求（Requests）**: コンテナが正常に動作するために必要な最小リソース量
- **リソース制限（Limits）**: コンテナが使用できる最大リソース量

### 基本的な仕組み

1. **スケジューリング時の動作**
   - リソース要求に基づいて、適切なノードが選択される
   - 要求されたリソースが利用可能なノードにのみポッドが配置される

2. **実行時の動作**
   - リソース制限を超えると、コンテナは制限される
   - CPU制限を超えると、スロットリングが発生
   - メモリ制限を超えると、コンテナは終了される可能性がある

## 2. ユースケース

### 2.1 安定性の確保
- アプリケーションが予期せず大量のリソースを使用するのを防ぐ
- 他のアプリケーションへの影響を最小限に抑える

### 2.2 コスト最適化
- リソースの過剰割り当てを防ぐ
- クラスターのリソース使用効率を向上させる

### 2.3 パフォーマンス保証
- 重要なアプリケーションに必要なリソースを保証
- サービスレベル目標（SLO）の達成を支援

## 3. 実装のステップ

### ステップ1: アプリケーションのリソース使用量の分析
1. 現在のリソース使用状況を確認
2. ピーク時の使用量を把握
3. 必要なリソース量を推定

### ステップ2: リソース要求の設定
1. 最小限必要なリソース量を決定
2. 適切な単位で指定（CPU: cores/millicores、メモリ: Mi/Gi）

### ステップ3: リソース制限の設定
1. 最大許容リソース量を決定
2. アプリケーションの特性に応じて制限を設定

### ステップ4: 設定の検証
1. 設定の適用
2. アプリケーションの動作確認
3. 必要に応じて調整

## 4. 実装例

### 基本的な設定例

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: frontend
spec:
  containers:
  - name: app
    image: nginx
    resources:
      requests:  # 最小保証リソース
        memory: "64Mi"
        cpu: "250m"
      limits:    # 最大使用可能リソース
        memory: "128Mi"
        cpu: "500m"
```

### よくある設定パターン

1. **Webアプリケーション**
   - 要求: CPU 200m、メモリ 256Mi
   - 制限: CPU 500m、メモリ 512Mi

2. **データベース**
   - 要求: CPU 500m、メモリ 1Gi
   - 制限: CPU 1000m、メモリ 2Gi

3. **バッチ処理**
   - 要求: CPU 100m、メモリ 128Mi
   - 制限: CPU 200m、メモリ 256Mi

## 5. トラブルシューティング

### よくある問題と解決方法

1. **OOMKilled（メモリ制限超過）**
   - 症状: コンテナが突然終了
   - 解決: メモリ制限の見直し、メモリリークの調査

2. **CPUスロットリング**
   - 症状: アプリケーションの応答が遅い
   - 解決: CPU制限の見直し、アプリケーションの最適化

3. **スケジューリング失敗**
   - 症状: ポッドがスケジュールされない
   - 解決: リソース要求の見直し、ノードのリソース確認

## 6. ベストプラクティス

1. **適切なリソース量の設定**
   - 実際の使用量に基づいて設定
   - 定期的な見直しと調整

2. **段階的な調整**
   - 小さな値から始めて徐々に調整
   - 本番環境での急激な変更を避ける

3. **モニタリングの活用**
   - リソース使用量の継続的な監視
   - アラートの設定

## 参考資料

- [リソース要求と制限の公式ドキュメント](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits)
- [デフォルトメモリ制限と要求の動機](https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/#motivation-for-default-memory-limits-and-requests)
- [Kubernetesリソースタイプの理解](https://thenewstack.io/understanding-kubernetes-resource-types/)
