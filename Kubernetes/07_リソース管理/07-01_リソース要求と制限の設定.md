# リソース要求と制限の設定

## 1. はじめに

Kubernetesクラスターでアプリケーションを実行する際、リソースの適切な管理に悩んでいませんか？コンテナが予期せず大量のリソースを使用して他のアプリケーションに影響を与えたり、逆にリソース不足でアプリケーションが正常に動作しなかったりする問題を経験したことはありませんか？

この記事では、Kubernetesのリソース要求（Requests）と制限（Limits）の設定方法について解説します。適切なリソース管理を実現することで、アプリケーションの安定性を確保し、クラスターの効率的な運用が可能になります。

## 2. ざっくり理解しよう

Kubernetesのリソース管理の重要なポイントは3つあります：

1. **リソース要求（Requests）**
   - コンテナが正常に動作するために必要な最小リソース量
   - スケジューリング時の判断基準となる
   - 例：CPU 200m、メモリ 256Mi

2. **リソース制限（Limits）**
   - コンテナが使用できる最大リソース量
   - 実行時のリソース使用を制限
   - 例：CPU 500m、メモリ 512Mi

3. **リソース管理の効果**
   - アプリケーションの安定性確保
   - クラスターリソースの効率的な利用
   - コスト最適化

## 3. 実際の使い方

### 3.1 安定性の確保
- アプリケーションが予期せず大量のリソースを使用するのを防ぐ
- 他のアプリケーションへの影響を最小限に抑える
- サービスレベル目標（SLO）の達成を支援

### 3.2 コスト最適化
- リソースの過剰割り当てを防ぐ
- クラスターのリソース使用効率を向上させる
- 予算管理とコスト最適化

### 3.3 パフォーマンス保証
- 重要なアプリケーションに必要なリソースを保証
- パフォーマンスの予測可能性を確保
- リソース競合の防止

## 4. 手を動かしてみよう

### ステップ1: アプリケーションのリソース使用量の分析
1. 現在のリソース使用状況を確認
2. ピーク時の使用量を把握
3. 必要なリソース量を推定

### ステップ2: リソース要求の設定
1. 最小限必要なリソース量を決定
2. 適切な単位で指定（CPU: cores/millicores、メモリ: Mi/Gi）

### ステップ3: リソース制限の設定
1. 最大許容リソース量を決定
2. アプリケーションの特性に応じて制限を設定

### ステップ4: 設定の検証
1. 設定の適用
2. アプリケーションの動作確認
3. 必要に応じて調整

## 5. 実践的なサンプル

### 基本的な設定例

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: frontend
spec:
  containers:
  - name: app
    image: nginx
    resources:
      requests:  # 最小保証リソース
        memory: "64Mi"
        cpu: "250m"
      limits:    # 最大使用可能リソース
        memory: "128Mi"
        cpu: "500m"
```

### よくある設定パターン

1. **Webアプリケーション**
   - 要求: CPU 200m、メモリ 256Mi
   - 制限: CPU 500m、メモリ 512Mi

2. **データベース**
   - 要求: CPU 500m、メモリ 1Gi
   - 制限: CPU 1000m、メモリ 2Gi

3. **バッチ処理**
   - 要求: CPU 100m、メモリ 128Mi
   - 制限: CPU 200m、メモリ 256Mi

## 6. 困ったときは

### よくある問題と解決方法

1. **OOMKilled（メモリ制限超過）**
   - 症状: コンテナが突然終了
   - 解決: メモリ制限の見直し、メモリリークの調査

2. **CPUスロットリング**
   - 症状: アプリケーションの応答が遅い
   - 解決: CPU制限の見直し、アプリケーションの最適化

3. **スケジューリング失敗**
   - 症状: ポッドがスケジュールされない
   - 解決: リソース要求の見直し、ノードのリソース確認

## 7. もっと知りたい人へ

### 次のステップ
- リソース使用状況の監視と最適化
- 名前空間へのクォータ割り当て
- 自動スケーリングの設定

### おすすめの学習リソース
- [リソース要求と制限の公式ドキュメント](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#requests-and-limits)
- [デフォルトメモリ制限と要求の動機](https://kubernetes.io/docs/tasks/administer-cluster/manage-resources/memory-default-namespace/#motivation-for-default-memory-limits-and-requests)
- [Kubernetesリソースタイプの理解](https://thenewstack.io/understanding-kubernetes-resource-types/)

### コミュニティ情報
- Kubernetes Slack: #sig-node
- Stack Overflow: kubernetes タグ
- GitHub: kubernetes/kubernetes
