# ロールベースアクセス制御（RBAC）

## 1. RBACとは

Kubernetesのロールベースアクセス制御（RBAC）は、ユーザーやグループに割り当てられたロールに基づいて、クラスターリソースへのアクセスを制御する仕組みです。これにより、セキュリティを確保しながら、適切なアクセス権限を付与することができます。

### 基本的な仕組み

1. **ロール（Role）**
   - 名前空間スコープの権限セット
   - リソースと操作の組み合わせを定義

2. **クラスターロール（ClusterRole）**
   - クラスター全体に適用される権限セット
   - クラスター全体のリソースへのアクセスを制御

3. **ロールバインディング（RoleBinding）**
   - ロールとユーザー/グループを紐付け
   - 名前空間内での権限を付与

4. **クラスターロールバインディング（ClusterRoleBinding）**
   - クラスターロールとユーザー/グループを紐付け
   - クラスター全体の権限を付与

## 2. ユースケース

### 2.1 マルチテナント環境
- 各チームに必要な権限のみを付与
- 名前空間ごとのアクセス制御
- リソースの分離と保護

### 2.2 開発・運用環境の分離
- 開発者と運用者の権限分離
- 本番環境へのアクセス制限
- 変更管理プロセスの実施

### 2.3 コンプライアンス対応
- 最小権限の原則の適用
- アクセス権限の監査
- セキュリティポリシーの実施

## 3. 実装のステップ

### ステップ1: アクセス要件の分析
1. ユーザー/グループの特定
2. 必要な権限の定義
3. アクセス制御の範囲の決定

### ステップ2: ロールの設計
1. ロールの種類の決定
2. 権限の細分化
3. ロールの階層化（必要に応じて）

### ステップ3: バインディングの設定
1. ロールバインディングの作成
2. クラスターロールバインディングの作成
3. サービスアカウントの設定

### ステップ4: 設定の検証
1. 権限のテスト
2. アクセス制御の確認
3. 必要に応じて調整

## 4. 実装例

### 基本的なロールの定義

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  namespace: default
  name: pod-reader
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "watch", "list"]
```

### ロールバインディングの設定

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: read-pods
  namespace: default
subjects:
- kind: User
  name: jane
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io
```

### よくある設定パターン

1. **開発者ロール**
   - 名前空間内のPod、Service、ConfigMapの読み書き
   - デプロイメントの作成と更新
   - ログの閲覧

2. **運用者ロール**
   - クラスター全体の監視
   - ノードの管理
   - バックアップとリストア

3. **管理者ロール**
   - クラスター全体の管理
   - セキュリティ設定の変更
   - ユーザーと権限の管理

## 5. トラブルシューティング

### よくある問題と解決方法

1. **アクセス拒否エラー**
   - 症状: 操作が拒否される
   - 解決: 権限の確認、ロールバインディングの見直し

2. **予期せぬ権限**
   - 症状: 意図しない操作が可能
   - 解決: ロールの見直し、最小権限の原則の適用

3. **サービスアカウントの問題**
   - 症状: アプリケーションが操作できない
   - 解決: サービスアカウントの権限確認

## 6. ベストプラクティス

1. **最小権限の原則**
   - 必要最小限の権限のみを付与
   - 定期的な権限の見直し

2. **名前空間の活用**
   - 適切な名前空間の分離
   - 名前空間ごとの権限管理

3. **定期的な監査**
   - 権限の使用状況の監視
   - 不要な権限の削除

## 参考資料

- [RBACのベストプラクティス公式ドキュメント](https://kubernetes.io/docs/concepts/security/rbac-good-practices/)
- [Kubernetesアクセス制御の基礎](https://thenewstack.io/a-primer-on-kubernetes-access-control/)
- [Kubernetes認可の実践的な理解](https://thenewstack.io/a-practical-approach-to-understanding-kubernetes-authorization/)
