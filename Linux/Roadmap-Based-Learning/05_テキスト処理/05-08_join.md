# 【Linux講座】joinコマンド

## 概要
joinコマンドはLinuxにおいて、共通フィールドを持つ2つのファイルを結合するためのツールであり、データ処理やテキスト操作において非常に有用です。

## 主要概念
joinコマンドはSQLのJOIN操作に似た方法で、2つのファイルの行を共通のフィールド（キー）に基づいて結合し、関連データを一つの行にまとめます。

## 実践コマンド例

### 1. 基本的なjoinの使い方

まず、テスト用のファイルを2つ作成します：

```bash
cat > file1.txt << EOL
1 apple
2 banana
3 cherry
4 date
EOL

cat > file2.txt << EOL
1 100
2 200
3 300
5 500
EOL
```

このコマンドを入力して実行してみましょう。2つのファイルが作成され、file1.txtには商品名、file2.txtには価格が含まれています。

次に、基本的なjoinコマンドを実行します：

```bash
join file1.txt file2.txt
```

このコマンドを入力して実行してみましょう。以下のような出力が表示されます：

```
1 apple 100
2 banana 200
3 cherry 300
```

**解説**：
両方のファイルに共通する最初のフィールド（この場合は番号1、2、3）に基づいて行が結合されました。注意点として、番号4と5は片方のファイルにしか存在しないため、デフォルトでは出力されません。

### 2. 欠損データを含む結合（外部結合）

左側のファイルのすべての行を表示するには（SQLのLEFT JOIN相当）：

```bash
join -a 1 file1.txt file2.txt
```

このコマンドを入力して実行してみましょう。以下のような出力が表示されます：

```
1 apple 100
2 banana 200
3 cherry 300
4 date
```

**解説**：
`-a 1`オプションにより、1番目のファイル（左側、file1.txt）にあるすべての行が出力に含まれます。番号4はfile2.txtにはありませんが、file1.txtにあるため表示されています。

右側のファイルのすべての行を表示するには：

```bash
join -a 2 file1.txt file2.txt
```

このコマンドを入力して実行してみましょう。以下のような出力が表示されます：

```
1 apple 100
2 banana 200
3 cherry 300
5 500
```

**解説**：
`-a 2`オプションにより、2番目のファイル（右側、file2.txt）にあるすべての行が出力に含まれます。

両方のファイルのすべての行を表示するには（SQLのFULL OUTER JOIN相当）：

```bash
join -a 1 -a 2 file1.txt file2.txt
```

このコマンドを入力して実行してみましょう。以下のような出力が表示されます：

```
1 apple 100
2 banana 200
3 cherry 300
4 date
5 500
```

**解説**：
`-a 1 -a 2`オプションにより、両方のファイルにあるすべての行が出力に含まれます。

### 3. 異なるフィールドでの結合

異なる位置のフィールドで結合する場合：

```bash
cat > employee.txt << EOL
101 Alice Engineering
102 Bob Marketing
103 Charlie Sales
EOL

cat > salary.txt << EOL
Engineering 101 5000
Marketing 102 4500
Sales 103 4000
EOL
```

このコマンドを入力して実行してみましょう。2つの新しいファイルが作成されます。

異なるフィールド位置で結合するには：

```bash
join -1 1 -2 2 employee.txt salary.txt
```

このコマンドを入力して実行してみましょう。しかし、このコマンドはエラーになるはずです。なぜなら、joinコマンドはデフォルトで両方のファイルがキーフィールドでソートされていることを想定しているからです。

まず、ファイルを適切にソートするために、salary.txtの内容を変更します：

```bash
cat > salary.txt << EOL
101 Engineering 5000
102 Marketing 4500
103 Sales 4000
EOL
```

このコマンドを入力して実行してみましょう。これで、両方のファイルが最初のフィールドでソートされるようになりました。

改めて結合を試みます：

```bash
join employee.txt salary.txt
```

このコマンドを入力して実行してみましょう。以下のような出力が表示されます：

```
101 Alice Engineering Engineering 5000
102 Bob Marketing Marketing 4500
103 Charlie Sales Sales 4000
```

**解説**：
両方のファイルが第1フィールド（社員ID）でソートされ、結合されました。ただし、重複した情報（部署名）が表示されています。

### 4. 出力フィールドの制御

特定のフィールドだけを出力するには：

```bash
join -o 1.2,1.3,2.3 employee.txt salary.txt
```

このコマンドを入力して実行してみましょう。以下のような出力が表示されます：

```
Alice Engineering 5000
Bob Marketing 4500
Charlie Sales 4000
```

**解説**：
`-o`オプションを使うと、出力するフィールドを細かく制御できます。この例では、「1.2」は1番目のファイルの2番目のフィールド（社員名）、「1.3」は1番目のファイルの3番目のフィールド（部署）、「2.3」は2番目のファイルの3番目のフィールド（給与）を表します。

### 5. 区切り文字の変更

CSVファイルのような、異なる区切り文字を持つファイルを処理するには：

```bash
cat > items.csv << EOL
ID,Name,Category
1,Laptop,Electronics
2,Desk,Furniture
3,Phone,Electronics
EOL

cat > prices.csv << EOL
ID,Price,Stock
1,1200,10
2,350,5
3,800,15
EOL
```

このコマンドを入力して実行してみましょう。コンマ区切りの2つのCSVファイルが作成されます。

区切り文字を指定して結合するには：

```bash
join -t, -1 1 -2 1 <(tail -n +2 items.csv) <(tail -n +2 prices.csv)
```

このコマンドを入力して実行してみましょう。以下のような出力が表示されます：

```
1,Laptop,Electronics,1200,10
2,Desk,Furniture,350,5
3,Phone,Electronics,800,15
```

**解説**：
- `-t,` は区切り文字としてコンマを使用するよう指定します
- `-1 1 -2 1` は両方のファイルの1番目のフィールド（ID）で結合するよう指定します
- `<(tail -n +2 ...)` はヘッダー行を除外するためのプロセス置換です

以上がjoinコマンドの基本的な使い方です。joinコマンドはデータ処理やレポート作成において非常に便利なツールで、適切に使えば複数のデータソースを効率的に結合できます。
